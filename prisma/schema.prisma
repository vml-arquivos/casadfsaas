generator client { provider = "prisma-client-js" }
datasource db { provider = "postgresql" url = env("DATABASE_URL") }

model Tenant {
  id        String @id @default(uuid())
  name      String
  slug      String @unique
  domain    String?
  themeJson Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  leads     Lead[]
  deals     Deal[]
  properties Property[]
  subscriptions Subscription[]
  auditLogs AuditLog[]
}

model User {
  id        String @id @default(uuid())
  tenantId  String
  email     String @unique
  name      String
  passwordHash String
  roleId    String?
  mfaEnabled Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  role   Role?  @relation(fields: [roleId], references: [id])
  activities Activity[]
  auditLogs AuditLog[]
}

model Role {
  id        String @id @default(uuid())
  tenantId  String
  name      String
  permissions String[]
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  users  User[]

  @@unique([tenantId, name])
}

model Lead {
  id        String @id @default(uuid())
  tenantId  String
  name      String
  phone     String?
  email     String?
  status    String @default("cold")
  stage     String @default("Contato")
  aiContext Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  deals Deal[]
  activities Activity[]
}

model Deal {
  id        String @id @default(uuid())
  tenantId  String
  leadId    String
  title     String
  amount    Float?
  stage     String @default("Contato")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
  lead Lead @relation(fields: [leadId], references: [id])
}

model Activity {
  id        String @id @default(uuid())
  tenantId  String
  leadId    String?
  userId    String?
  type      String
  note      String?
  at        DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  lead Lead? @relation(fields: [leadId], references: [id])
  user User? @relation(fields: [userId], references: [id])
}

model Property {
  id        String @id @default(uuid())
  tenantId  String
  slug      String @unique
  title     String
  description String?
  city      String
  district  String?
  type      String
  price     Float
  bedrooms  Int?
  bathrooms Int?
  parking   Int?
  area      Float?
  images    String[]
  aiDescription String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id])
}

model Plan {
  id        String @id @default(uuid())
  name      String @unique
  monthlyPrice Float
  yearlyPrice Float
  maxLeads  Int
  maxAgents Int
  maxProperties Int
  aiFeatures Boolean @default(true)
  autopilot Boolean @default(true)
  automations Boolean @default(true)
  customDomain Boolean @default(false)
  storageGB Int @default(5)
  stripePriceId String?
}

model Subscription {
  id        String @id @default(uuid())
  tenantId  String
  planId    String
  stripeCustomerId String?
  stripeSubscriptionId String?
  status    String @default("trialing")
  renewAt   DateTime?
  cancelAt  DateTime?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  plan Plan @relation(fields: [planId], references: [id])
}

model AuditLog {
  id        String @id @default(uuid())
  tenantId  String
  userId    String?
  action    String
  entity    String
  entityId  String?
  before    Json?
  after     Json?
  ip        String?
  createdAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id])
  user   User?  @relation(fields: [userId], references: [id])
}
